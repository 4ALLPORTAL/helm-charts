{{ $apiKey := "4allportal.fourAllPortal.systemApiKey" }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: "{{ include "common.names.fullname" . }}-backend"
  namespace: {{ .Release.Namespace }}
  labels: {{- include "common.labels.standard" $ | nindent 4 }}
    app.kubernetes.io/component: backend
spec:
  strategy:
    {{- if (and (or (not (or .Values.global.persistence.enabled .Values.fourAllPortal.persistence.config.enabled)) (eq .Values.fourAllPortal.persistence.config.accessMode "ReadWriteMany")) (or (not (or .Values.global.persistence.enabled .Values.fourAllPortal.persistence.assets.enabled)) (eq .Values.fourAllPortal.persistence.assets.accessMode "ReadWriteMany"))) }}
    type: RollingUpdate
    {{- else }}
    type: Recreate
  {{- end }}
  {{- if not .Values.fourAllPortal.hpa.enabled }}
  replicas: {{ .Values.fourAllPortal.replicas }}
  {{- else }}
  replicas: {{ .Values.fourAllPortal.hpa.minReplicas }}
  {{- end }}
  selector:
    matchLabels: {{- include "common.labels.matchLabels" $ | nindent 6 }}
      app.kubernetes.io/component: backend
  template:
    metadata:
      labels: {{- include "common.labels.stable" $ | nindent 8 }}
        app.kubernetes.io/component: backend
      annotations:
        checksum/secret: {{ include (print $.Template.BasePath "/4allportal/secrets.yaml") . | sha256sum }}
    spec:
      {{- if .Values.maxscale.enabled }}
      affinity:
        podAffinity: {{- include "common.affinities.pods.soft" (dict "context" (dict "Release" $.Release "Chart" (dict "Name" "maxscale") "Values" $.Values.maxscale.mariadb)) | nindent 10 }}
      {{- end }}
      topologySpreadConstraints:
        - maxSkew: 1
          topologyKey: topology.kubernetes.io/zone
          whenUnsatisfiable: DoNotSchedule
          labelSelector:
            matchLabels: {{- include "common.labels.matchLabels" $ | nindent 14 }}
              app.kubernetes.io/component: backend
        - maxSkew: 1
          topologyKey: kubernetes.io/hostname
          whenUnsatisfiable: ScheduleAnyway
          labelSelector:
            matchLabels: {{- include "common.labels.matchLabels" $ | nindent 14 }}
              app.kubernetes.io/component: backend
      {{- include "4allportal.webdav.priorityClassName" $ | nindent 6 }}
      {{- .Values.fourAllPortal.securityOptions | toYaml | nindent 6 }}
      automountServiceAccountToken: true
      serviceAccountName: "{{ include "common.names.fullname" . }}-backend"
      securityContext: {{- .Values.fourAllPortal.securityContext | toYaml | nindent 8 }}
      enableServiceLinks: false
      containers:
        - name: {{ .Chart.Name }}
          securityContext: {{- .Values.fourAllPortal.containerSecurityContext | toYaml | nindent 12 }}
          image: {{ template "4allportal.image" . }}
          {{- if .Values.fourAllPortal.image.repository | contains "@" }}
          imagePullPolicy: IfNotPresent
          {{- else }}
          imagePullPolicy: Always
          {{- end }}
          env:
            {{- $apps := dict -}}
            {{- if .Values.fourAllPortal.fourApps -}}
            {{- range $app, $version := .Values.fourAllPortal.fourApps -}}
            {{- $apps = set $apps $app $version -}}
            {{- end -}}
            {{- end -}}
            {{- if $apps -}}
            {{- $appsList := list -}}
            {{- range $app, $version := $apps -}}
            {{- $appsList = append $appsList (printf "%s:%s" $app $version) -}}
            {{- end }}
            - name: APPS_INSTALL
              value: "{{ $appsList | join "," }}"
            {{- end }}
            - name: GENERAL_EXTERNAL_URL
              {{- if .Values.fourAllPortal.ingress.enabled }}
              value: "https://{{ .Values.fourAllPortal.ingress.host }}"
              {{- else }}
              value: "https://localhost"
            {{- end }}
            - name: GENERAL_ADMIN_USER_NAME
              value: {{ .Values.fourAllPortal.general.admin.username | quote }}
            - name: GENERAL_ADMIN_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ include "common.secrets.name" (dict "existingSecret" (dict) "defaultNameSuffix" "general" "context" $) }}
                  key: {{ include "common.secrets.key" (dict "existingSecret" (dict) "key" "admin-password") }}
            - name: GENERAL_ADMIN_EMAIL
              value: {{ required "You must provide the email for the administrator" .Values.fourAllPortal.general.admin.email | quote }}
            - name: GENERAL_ADMIN_FIRSTNAME
              value: {{ .Values.fourAllPortal.general.admin.firstName | quote }}
            - name: GENERAL_ADMIN_LASTNAME
              value: {{ .Values.fourAllPortal.general.admin.lastName | quote }}
            - name: GENERAL_DEFAULT_LANGUAGE
              value: {{ .Values.fourAllPortal.general.defaultLanguage | quote }}

            - name: DEBUG
              value: {{ .Values.fourAllPortal.debug | quote }}

            - name: SYSTEM_API_KEY
              value: {{ $apiKey }}

            - name: MANAGED
              value: "true"

            - name: MAIL_ENABLED
              value: {{ .Values.fourAllPortal.mail.enabled | quote }}
            {{- if .Values.fourAllPortal.mail.enabled }}
            - name: MAIL_HOST
              value: {{ required "You must provide a mail host, when enabling mail" .Values.fourAllPortal.mail.host | quote }}
            - name: MAIL_PORT
              value: {{ .Values.fourAllPortal.mail.port | quote }}
            - name: MAIL_USE_AUTHENTICATION
              value: {{ .Values.fourAllPortal.mail.useAuthentication | quote }}
            {{- if .Values.fourAllPortal.mail.useAuthentication }}
            - name: MAIL_USER
              value: {{ required "You must provide a mail user, when enabling mail authentication. If this is not a mistake, set `useAuthentication: false`" .Values.fourAllPortal.mail.user | quote }}
            - name: MAIL_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ include "common.secrets.name" (dict "existingSecret" (dict) "defaultNameSuffix" "mail" "context" $) }}
                  key: {{ include "common.secrets.key" (dict "existingSecret" (dict) "key" "password") }}
            {{- end }}
            - name: MAIL_SYSTEM_FROM_EMAIL
              value: {{ required "You must provide a sender address, when enabling mail" .Values.fourAllPortal.mail.system.from.email | quote }}
            - name: MAIL_SYSTEM_FROM_NAME
              value: {{ required "You must provide a sender name, when enabling mail" .Values.fourAllPortal.mail.system.from.name | quote }}
            - name: MAIL_USE_REPLY_TO
              value: {{ .Values.fourAllPortal.mail.replyTo | default (not (empty .Values.fourAllPortal.mail.system.replyTo.email)) | quote }}
            - name: MAIL_SYSTEM_MAIL_SENDER
              value: {{ .Values.fourAllPortal.mail.system.sender | quote }}
            - name: MAIL_SYSTEM_REPLY_TO_EMAIL
              value: {{ .Values.fourAllPortal.mail.system.replyTo.email | quote }}
            {{- if (not .Values.fourAllPortal.mail.system.sender) }}
            {{- if and (.Values.fourAllPortal.mail.replyTo) (not .Values.fourAllPortal.mail.system.replyTo.email) }}
            {{- fail "If mail is enabled either the sender or the replyTo email must be provided" }}
            {{- end }}
            {{- end }}
            - name: MAIL_SECURITY
              value: {{ .Values.fourAllPortal.mail.security | quote }}
            {{- end }}

            {{- if and .Values.fourAllPortal.database.operator.enabled (not .Values.maxscale.enabled) }}
            - name: DATABASE_USER
              value: {{ required "You must set a database user when using the operator." .Values.fourAllPortal.database.operator.user | quote }}
            - name: DATABASE_PASSWORD
              value: {{ required "You must set a user password when using the operator." .Values.fourAllPortal.database.operator.password | quote }}
            - name: DATABASE_TYPE
              valueFrom:
                configMapKeyRef:
                  name: {{ .Values.fourAllPortal.database.operator.databaseRef }}-configmap
                  key: "DATABASE_TYPE"
            - name: DATABASE_HOST
              valueFrom:
                configMapKeyRef:
                  name: {{ .Values.fourAllPortal.database.operator.databaseRef }}-configmap
                  key: "DATABASE_HOST"
            - name: DATABASE_PORT
              valueFrom:
                configMapKeyRef:
                  name: {{ .Values.fourAllPortal.database.operator.databaseRef }}-configmap
                  key: "DATABASE_PORT"
            - name: DATABASE_DATABASE_NAME
              value: {{ required "You must set a database name when using the operator." .Values.fourAllPortal.database.operator.databaseName | quote }}
            {{ else }}
            - name: DATABASE_USER
              value: {{ include "4allportal.fourallportal.database.user" . | quote }}
            - name: DATABASE_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ include "common.secrets.name" (dict "existingSecret" .Values.fourAllPortal.database.existing.existingSecret "defaultNameSuffix" "database" "context" $) }}
                  key: {{ include "common.secrets.key" (dict "existingSecret" .Values.fourAllPortal.database.existing.existingSecret "key" "password") }}
            - name: DATABASE_TYPE
              value: {{ include "4allportal.fourallportal.database.type" . | quote }}
            - name: DATABASE_HOST
              value: {{ include "4allportal.fourallportal.database.host" . | quote }}
            - name: DATABASE_PORT
              value: {{ include "4allportal.fourallportal.database.port" . | quote }}
            - name: DATABASE_DATABASE_NAME
              value: {{ include "4allportal.fourallportal.database.name" . | quote }}
            {{- end }}
            - name: DATABASE_INITIAL_POOL_SIZE
              value: {{ .Values.fourAllPortal.database.initialPoolSize | quote }}
            - name: DATABASE_MAX_IDLE_TIME
              value: {{ .Values.fourAllPortal.database.maxIdleTime | quote }}
            - name: DATABASE_MAX_POOL_SIZE
              value: {{ .Values.fourAllPortal.database.maxPoolSize | quote }}
            - name: DATABASE_MIN_POOL_SIZE
              value: {{ .Values.fourAllPortal.database.minPoolSize | quote }}
            - name: DATABASE_NUM_HELPER_THREADS
              value: {{ .Values.fourAllPortal.database.numHelperThreads | quote }}
            - name: DATABASE_ACQUIRE_INCREMENT
              value: {{ .Values.fourAllPortal.database.acquireIncrement | quote }}
            - name: KUBERNETES_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: KUBERNETES_DEPLOYMENT
              value: "{{ include "common.names.fullname" . }}-backend"

            - name: LOGGING_PATTERN_CONSOLE
              value: "{\"time\": \"%d\", \"thread\": \"%thread\", \"level\": \"%p\", \"logger\": \"%logger{63}\", \"line\": \"%L\", \"message\": \"%replace(%replace(%m%wEx{6}){'[\r\n]+', '\\\\n'}%nopex\"}){'[\t]+', '\\\\t'}%n"

            {{- include "4allportal.tracing.jaeger.env" (dict "Chart" .Chart "Release" .Release "Values" .Values "local" .Values.fourAllPortal.tracing) | nindent 12 }}

            {{- range $name, $value := .Values.fourAllPortal.env }}
            - name: {{ $name }}
              value: {{ $value | quote }}
          {{- end }}
          ports:
            - name: http
              containerPort: 8181
              protocol: TCP
            {{- if .Values.fourAllPortal.debug }}
            - name: debug
              containerPort: 8001
              protocol: TCP
            {{- end }}
            {{- if .Values.fourAllPortal.metrics.enabled }}
            - name: metrics
              containerPort: 8181
              protocol: TCP
          {{- end }}
          {{- if and (not .Values.fourAllPortal.debug) .Values.fourAllPortal.livenessProbe.enabled }}
          livenessProbe:
            exec:
              command:
                - bash
                - -c
                - |
                  timeout {{ .Values.fourAllPortal.livenessProbe.timeoutSeconds }} curl --silent -f localhost:8181/health &&
                  timeout 1 ls -d /4allportal/data && timeout 1 ls -d /4allportal/assets
            failureThreshold: {{ .Values.fourAllPortal.livenessProbe.failureThreshold }}
            initialDelaySeconds: {{ .Values.fourAllPortal.livenessProbe.initialDelaySeconds }}
            periodSeconds: {{ .Values.fourAllPortal.livenessProbe.periodSeconds }}
            successThreshold: {{ .Values.fourAllPortal.livenessProbe.successThreshold }}
            timeoutSeconds: {{ .Values.fourAllPortal.livenessProbe.timeoutSeconds }}
          {{- end }}
          {{- if .Values.fourAllPortal.readinessProbe.enabled }}
          readinessProbe:
            httpGet:
              path: /health
              port: http
            failureThreshold: {{ .Values.fourAllPortal.readinessProbe.failureThreshold }}
            initialDelaySeconds: {{ .Values.fourAllPortal.readinessProbe.initialDelaySeconds }}
            periodSeconds: {{ .Values.fourAllPortal.readinessProbe.periodSeconds }}
            successThreshold: {{ .Values.fourAllPortal.readinessProbe.successThreshold }}
            timeoutSeconds: {{ .Values.fourAllPortal.readinessProbe.timeoutSeconds }}
          {{- end }}
          {{- if .Values.fourAllPortal.startupProbe.enabled }}
          startupProbe:
            httpGet:
              path: /health
              port: http
            failureThreshold: {{ .Values.fourAllPortal.startupProbe.failureThreshold }}
            initialDelaySeconds: {{ .Values.fourAllPortal.startupProbe.initialDelaySeconds }}
            periodSeconds: {{ .Values.fourAllPortal.startupProbe.periodSeconds }}
            successThreshold: {{ .Values.fourAllPortal.startupProbe.successThreshold }}
            timeoutSeconds: {{ .Values.fourAllPortal.startupProbe.timeoutSeconds }}
          {{- end }}
          volumeMounts:
            - name: tmp
              mountPath: /tmp
            - name: runtime
              mountPath: /4allportal/_runtime
            - name: assets
              mountPath: /4allportal/assets
            - name: config
              mountPath: /4allportal/data
            - name: read-only
              mountPath: /4allportal/data/data
              readOnly: true
          resources: {{- toYaml .Values.fourAllPortal.resources | nindent 12 }}
      initContainers: {{- include "common.tplvalues.render" (dict "value" .Values.fourAllPortal.initContainers "context" $) | nindent 8 }}
      volumes:
        - name: tmp
          emptyDir: { }
        - name: read-only
          emptyDir: { }
        - name: runtime
          emptyDir:
            medium: Memory
        - name: assets
        {{- include "4allportal.fourallportal.persistence.assets.mount" . | nindent 10 }}
        - name: config
      {{- include "4allportal.fourallportal.persistence.config.mount" . | nindent 10 }}
      {{- with .Values.fourAllPortal.nodeSelector }}
      nodeSelector: {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.fourAllPortal.hostAliases }}
      hostAliases: {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.fourAllPortal.affinity }}
      affinity: {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.fourAllPortal.tolerations }}
      tolerations: {{- toYaml . | nindent 8 }}
    {{- end }}
---
{{- if $.Values.webdav.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: "{{ include "common.names.fullname" $ }}-webdav"
  namespace: {{ .Release.Namespace }}
  labels: {{- include "common.labels.stable" $ | nindent 4 }}
data:
  groups: |
    {{- range $group, $users := $.Values.webdav.groups }}
      {{ $group -}}: {{ $users | join " " }}
    {{- end }}
  httpd.conf: |
    ServerRoot "/usr/local/apache2"
    {{ if .Values.fourAllPortal.ingress.enabled }}
    ServerName {{ .Values.fourAllPortal.ingress.host }}
    {{ end }}
    Listen 8080
    LoadModule auth_digest_module modules/mod_auth_digest.so
    LoadModule authn_core_module modules/mod_authn_core.so
    LoadModule authn_file_module modules/mod_authn_file.so
    LoadModule authz_core_module modules/mod_authz_core.so
    LoadModule authz_groupfile_module modules/mod_authz_groupfile.so
    LoadModule authz_user_module modules/mod_authz_user.so
    LoadModule autoindex_module modules/mod_autoindex.so
    LoadModule dav_module modules/mod_dav.so
    LoadModule dav_fs_module modules/mod_dav_fs.so
    LoadModule dir_module modules/mod_dir.so
    LoadModule headers_module modules/mod_headers.so
    LoadModule log_config_module modules/mod_log_config.so
    LoadModule logio_module modules/mod_logio.so
    LoadModule mime_module modules/mod_mime.so
    LoadModule mpm_event_module modules/mod_mpm_event.so
    LoadModule remoteip_module modules/mod_remoteip.so
    LoadModule setenvif_module modules/mod_setenvif.so
    LoadModule unixd_module modules/mod_unixd.so

    PidFile /dav/httpd.pid

    <IfModule remoteip_module>
      RemoteIPHeader X-Forwarded-For
    </IfModule>

    <Directory />
      AllowOverride none
      Require all denied
    </Directory>

    <Files ".DS_Store">
      Require all denied
    </Files>

    # This would cause trouble with Indesign (It would not be possible to save a file)
    #    <FilesMatch "^\._.*">
    #      Require all denied
    #    </FilesMatch>

    ErrorLog /proc/self/fd/2
    ErrorLogFormat "{\"ts\": \"%{cu}t\", \"module\": \"%-m\", \"level\": \"%l\", \"message\": \"%M\", \"clientIP\": \"%-a\"}"
    LogLevel {{ if .Values.fourAllPortal.debug -}}debug{{- else -}}info{{- end }}

    <IfModule log_config_module>
      CustomLog /proc/self/fd/1 "{\"ts\": \"%{%FT%T}t.%{msec_frac}t%{%z}t\", \"requestID\": \"%L\", \"connectionID\": \"%{c}L\", \"user\": \"%u\", \"level\": \"%l\", \"status\": \"%s\", \"method\": \"%m\", \"path\": \"%U\", \"query\": \"%q\", \"clientIP\": \"%a\", \"userAgent\": \"%{User-Agent}i\", \"bytesSent\": \"%O\", \"bytesReceived\": \"%I\"}"
      {{- if and ($.Values.webdav.events.enabled) (gt (int $.Values.fourAllPortal.replicas) 0) }}
      CustomLog "| /usr/local/apache2/bin/rotatelogs -t -f -c /dav-events/logfile 1M" "%s;%m;%U;%{Destination}i"
      {{ end }}
    </IfModule>

    <IfModule mime_module>
      TypesConfig conf/mime.types

      AddType application/x-compress .Z
      AddType application/x-gzip .gz .tgz
    </IfModule>

    Include conf/conf-enabled/dav.conf
    Include conf/sites-enabled/site.conf
    EnableMMAP off
  site.conf: |
    <VirtualHost *:8080>
      DocumentRoot "/dav/data"
      TimeOut 600
      <Directory "/dav/data">
        Require all denied
      </Directory>
      # This lets certain DAV methods work behind an SSL reverse proxy.
      RequestHeader edit Destination ^https http early
    </VirtualHost>
  dav.conf: |
    DavLockDB "/dav/DavLockDB"
    {{ range $path, $permissions := $.Values.webdav.mounts }}
    <Directory "/dav/data/webdav{{- $path -}}">
      DAV On
      DavDepthInfinity On
      DavMinTimeout 600
      DirectorySlash Off
      LimitRequestBody 4294967296

      IndexOptions +Charset=UTF-8
      Options Indexes FollowSymLinks MultiViews

      LimitXMLRequestBody 0

      AuthType Digest
      AuthName "WebDAV"
      AuthUserFile "/dav/user.passwd"
      AuthGroupFile "/dav/groups"

      <RequireAny>
        {{- with $users := $permissions.users }}
        Require user {{ $users | join " " }}
        {{- end }}
        {{- with $groups := $permissions.groups }}
        Require group {{ $groups | join " " }}
        {{- end }}
        {{- if and (not $permissions.users) (not $permissions.groups) }}
        Require all denied
        {{- end }}
      </RequireAny>
    </Directory>
    {{ end }}
    # These disable redirects on non-GET requests for directories that
    # don't include the trailing slash (for misbehaving clients).
    BrowserMatch "Microsoft Data Access Internet Publishing Provider" redirect-carefully
    BrowserMatch "MS FrontPage" redirect-carefully
    BrowserMatch "^WebDrive" redirect-carefully
    BrowserMatch "^WebDAVFS/1.[01234]" redirect-carefully
    BrowserMatch "^gnome-vfs/1.0" redirect-carefully
    BrowserMatch "^XML Spy" redirect-carefully
    BrowserMatch "^Dreamweaver-WebDAV-SCM1" redirect-carefully
    BrowserMatch " Konqueror/4" redirect-carefully
    BrowserMatch "^gvfs" redirect-carefully
    BrowserMatch "WebDAVLib" redirect-carefully
  {{- if $.Values.webdav.events.enabled }}
  log-handler.sh: |
    #!/bin/ash
    MOUNT_POINT="/webdav/assets/"
    MOUNT_POINT_LEN=$(echo "$MOUNT_POINT" | awk '{print length($1) + 1;}')

    while IFS= read -r line; do
      status=$(echo "$line" | cut -d';' -f1)
      type=$(echo "$line" | cut -d';' -f2)
      path=$(echo "$line" | cut -d';' -f3)
      dest=$(echo "$line" | cut -d';' -f4 | awk '{
        i = index($1,"/webdav/");
        out = substr($1, i);
        for (i = 0x20; i < 0x40; ++i) {
          repl = sprintf("%c", i);
          if ((repl == "&") || (repl == "\\")) {
            repl = "\\" repl;
          }
          out = gensub(sprintf("%%%02X", i), repl, "g", out);
          out = gensub(sprintf("%%%02x", i), repl, "g", out);
        };
        out = gensub(/\"/, "\\\"", "g", out);
        print out}')

      matched=$(expr match "${path}" "$MOUNT_POINT.*")
      if [ \( "${type}" == "PUT" -o "${type}" == "DELETE" -o "${type}" == "MKCOL" -o "${type}" == "MOVE" -o "${type}" == "COPY" \) -a ${matched} != 0 ]
      then
        path=$(echo "$path" | cut -c ${MOUNT_POINT_LEN}- )
        if [ "${dest}" != "-" -a "${dest}" != "" ]
        then
          dest=$(echo "$dest" | cut -c ${MOUNT_POINT_LEN}- )
        fi

        lastChar=$(echo "$path" | awk '{print substr($0,length,1)}')
        if [ "$lastChar" = "/" ]
        then
          path=$(echo "$path" | awk '{print substr($0,0,length($0)-1)}')
        fi

        OP="UNKNOWN"
        if [ "${status}" == "201" -a "${type}" == "PUT" ]
        then
          OP="CREATE"
        elif [ "${status}" == "201" -a "${type}" == "MKCOL" ]
        then
          OP="CREATE"
        elif [ "${status}" == "201" -a "${type}" == "MOVE" ]
        then
          OP="MOVE"
        elif [ "${status}" == "201" -a "${type}" == "COPY" ]
        then
          OP="CREATE"
        elif [ "${status}" == "204" -a "${type}" == "PUT" ]
        then
          OP="UPDATE"
        elif [ "${status}" == "204" -a "${type}" == "DELETE" ]
        then
          OP="DELETE"
        fi
        BODY="{}"
        ENDPOINT="http://{{ include "common.names.fullname" . }}-backend/api/extensions/dam/mounts/data/events/${OP}"
        if [ "${dest}" == "-" -o "${dest}" == "" ]
        then
          BODY="{\"path\":\"${path}\"}"
          echo "Send notification to ${ENDPOINT}: ${BODY}" > /proc/self/fd/1
        else
          BODY="{\"path\":\"${path}\",\"destination\":\"${dest}\"}"
          echo "Send notification to ${ENDPOINT}: ${BODY}" > /proc/self/fd/1
        fi
        RES_CODE=$(curl -X POST -sw "%{http_code}\n" \
          -H 'Content-Type: application/json' \
          -H "Authorization: Bearer {{ $apiKey }}" \
          -d "$BODY" \
          --connect-timeout 1 -o /dev/null ${ENDPOINT})
        echo "Response status: ${RES_CODE}"  > /proc/self/fd/1
      fi
    done
  {{- end }}
  {{- end }}